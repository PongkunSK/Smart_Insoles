<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="/public/css/Css Login.Css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="Bg">
    <div class="B">
        <h1 class="mb-4">LOGIN</h1>

        <form id="loginForm" class="shadow p-4 border rounded">
            <label for="rfid">RFID Tag:</label>
            <input type="text" id="rfid" name="rfid" class="form-control" required placeholder="Scan RFID here">

            <!-- Loading Spinner -->
            <div id="loading" style="display:none;">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p>Please wait while we process your login...</p>
            </div> 
        </form>
        <button type="button" onclick="loginUser()" class="btn btn-success w-100">Login</button>
        <!-- Back button -->
        <form action="/">
            <button type="submit" class="btn btn-danger w-100 mt-2">Back</button>
        </form>
    </div>

    <script>
        async function loginUser() {
    const rfid = document.getElementById('rfid').value.trim(); // Trim any spaces

    if (!rfid) {
        alert("Please enter RFID");
        return;
    }

    const loading = document.getElementById('loading');
    loading.style.display = 'block'; // Show spinner

    try {
        const response = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rfid }),
        });

        loading.style.display = 'none'; // Hide spinner

        if (response.ok) {
            const userData = await response.json();
            console.log("User data from response:", userData);

            // Store user data in sessionStorage
            sessionStorage.setItem('userFirstName', userData.firstName);
            sessionStorage.setItem('userLastName', userData.lastName);
            sessionStorage.setItem('rfid', rfid); // Save RFID

            if (userData.isAdmin) {
                window.location.replace('/admin');
            } else {
                window.location.replace('/Taker');
            }
        } else {
            const errorData = await response.json();
            alert("Login failed: " + errorData.message);
        }
    } catch (error) {
        loading.style.display = 'none'; // Hide spinner
        alert("Error connecting to the server: " + error.message);
    }
}
    </script>
</body>

</html>